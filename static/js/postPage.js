let postFound = false;

async function LoadPostPage(postID) {
    const dynamicContent = document.getElementById("content");
    if (postFound) {
        dynamicContent.innerHTML = `
        <div class="container">
            <!-- Back to Home -->
            <div class="back-home">
                <a href="/" class="back-link">&larr; Go Dar</a>
            </div>

            <!-- Post "content+title..." generated by js innerHTML-->
            <div id="postDiv"></div>

            <!-- Comments Section -->
            <div id="commentsSection">
                <!-- Add New Comment Form -->
                <div id="addCommentContainer">
                    <form id="commentForm">
                        <textarea id="commentContent" rows="3" placeholder="Write your comment..." maxlength="7000"
                            required></textarea>
                        <button type="submit" id="commentSubmit">Post Comment</button>
                    </form>
                </div>
                <br />
                <!-- Existing Comments List -->
                <h3>Comments</h3>
                <div id="commentsList"></div>
                <div id="showMoreContainer">
                    <button id="showMoreBtn" style="display: none;">Show older comments</button>
                </div>
            </div>
        </div>
        `;
    }

    // Flash delay to make sure all needed content is fully available
    document.querySelector('.container').style.display = 'none';
    if (postFound) {
        setTimeout(() => {
            document.querySelector('.container').style.display = 'block';
        }, 7);
    }

    // Clear the body and insert new content
    postFound = false;
    const postDiv = document.getElementById("postDiv");

    // Fetchers
    if (postID) {
        await FetchFullPost(postID);
        if (postFound) {
            FetchReactions(postID, postDiv, "post");
            FetchComments(postID);
        }
        postFound = false;
    } else {
        console.log("No post found");
        PopError("Something went wrong");
        return;
    }

    // Comment Listener
    const commentForm = document.getElementById("commentForm");
    const commentSubmit = document.getElementById("commentSubmit");
    commentForm.addEventListener("submit", (e) => {
        e.preventDefault();
        commentSubmit.disabled = true;

        setTimeout(() => {
            commentSubmit.disabled = false;
        }, 1000);

        const content = document.getElementById("commentContent").value;
        if (!content) return;
        AddComment(postID, content);
    });

    // Listen for "Show more" button click:
    document.getElementById("showMoreBtn").addEventListener("click", () => {
        commentOffset += 20;
        FetchComments(postID, true); // pass your postID variable
    });
}

// Send fetch to backEnd with post ID
async function FetchFullPost(id) {
    try {
        const res = await fetch(`/api/get-singlePost?post_id=${encodeURIComponent(id)}`);
        if (!res.ok) {
            const errData = await res.json();
            console.error("Failed to fetch post:", errData.msg);
            LoadNotFoundPage();
        } else {
            postFound = true;
            const post = await res.json();
            RenderPost(post, postDiv, "single");
            longTagNames();
        }
    } catch (err) {
        console.log(err);
        PopError("Something went wrong")
    }
}
